on: 
  release:
    types:
      - published

jobs:  
  publish:
    runs-on: ubuntu-latest
    env:
      RELEASE_TAG: ${{ github.event.release.tag_name }}
      REPOX_URL: "https://repox.jfrog.io/artifactory"
      NPM_REPOSITORY: "sonarsource-npm-public"
      SCOPE: "%40sonarsource/"
      PACKAGE: "sonar-dummy-js"
      VAULT_ADDR: https://vault.sonar.build:8200
    permissions:
      id-token: write
      contents: read
    steps:       
      - name: Vault Secrets
        uses: hashicorp/vault-action@7d98524254c38dc6892804f991526ff30905f643 # tag=v2.4.2
        with:
          url: ${{ env.VAULT_ADDR }}
          method: jwt
          path: jwt-ghwf
          role: github-sonarsource-sonar-dummy-js
          secrets: |
            development/kv/data/npmjs sonartech_npm_token | SONARTECH_NPM_TOKEN;
      - uses: actions/checkout@2541b1294d2704b0964813337f33b291d3f8596b # tag=v3.0.2
      - uses: actions/setup-node@969bd2663942d722d85b6a8626225850c2f7be4b # tag=v3.5.0
        with:
          node-version: 10      
      - name: Download artifacts        
        run: curl -o $PACKAGE-$RELEASE_TAG.tgz $REPOX_URL/$NPM_REPOSITORY/$SCOPE$PACKAGE/-/$SCOPE$PACKAGE-$RELEASE_TAG.tgz
      - run: mv .github/workflows/.npmrc ~/.npmrc 
      - name: Publish npm package            
        env:
          NPM_TOKEN: ${{ env.SONARTECH_NPM_TOKEN }}
        run: npm publish $PACKAGE-$RELEASE_TAG.tgz
